<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从vnode到更新视图 | 小兔在冲浪</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/blog/assets/common/favicon.ico">
    <meta name="description" content="web前端技术博客,简洁至上,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/blog/assets/css/0.styles.538de7b2.css" as="style"><link rel="preload" href="/blog/assets/js/app.307d5cc3.js" as="script"><link rel="preload" href="/blog/assets/js/2.05990a35.js" as="script"><link rel="preload" href="/blog/assets/js/8.a97ebc1a.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.523b168e.js"><link rel="prefetch" href="/blog/assets/js/100.8d46b3c3.js"><link rel="prefetch" href="/blog/assets/js/101.972d690b.js"><link rel="prefetch" href="/blog/assets/js/102.7ad2852d.js"><link rel="prefetch" href="/blog/assets/js/103.763b508f.js"><link rel="prefetch" href="/blog/assets/js/104.6f30d9e2.js"><link rel="prefetch" href="/blog/assets/js/105.7ceb872a.js"><link rel="prefetch" href="/blog/assets/js/106.042ea05a.js"><link rel="prefetch" href="/blog/assets/js/107.4e2f543c.js"><link rel="prefetch" href="/blog/assets/js/108.1f5f93fd.js"><link rel="prefetch" href="/blog/assets/js/109.9ae027c4.js"><link rel="prefetch" href="/blog/assets/js/11.a08c369f.js"><link rel="prefetch" href="/blog/assets/js/110.e0637519.js"><link rel="prefetch" href="/blog/assets/js/111.b1e7dadb.js"><link rel="prefetch" href="/blog/assets/js/112.b2cdf705.js"><link rel="prefetch" href="/blog/assets/js/113.8f6b04e2.js"><link rel="prefetch" href="/blog/assets/js/114.488e3911.js"><link rel="prefetch" href="/blog/assets/js/115.63922818.js"><link rel="prefetch" href="/blog/assets/js/116.b8767a7b.js"><link rel="prefetch" href="/blog/assets/js/117.7bccc294.js"><link rel="prefetch" href="/blog/assets/js/118.8f086bfe.js"><link rel="prefetch" href="/blog/assets/js/119.8f8a9738.js"><link rel="prefetch" href="/blog/assets/js/12.7ac2ce8b.js"><link rel="prefetch" href="/blog/assets/js/120.60b9ffc1.js"><link rel="prefetch" href="/blog/assets/js/121.57cf17b4.js"><link rel="prefetch" href="/blog/assets/js/122.5f930914.js"><link rel="prefetch" href="/blog/assets/js/123.5ddff238.js"><link rel="prefetch" href="/blog/assets/js/124.aaff2d7a.js"><link rel="prefetch" href="/blog/assets/js/125.da5129ee.js"><link rel="prefetch" href="/blog/assets/js/126.d2602dfc.js"><link rel="prefetch" href="/blog/assets/js/127.6faf1e77.js"><link rel="prefetch" href="/blog/assets/js/128.0d4f75e3.js"><link rel="prefetch" href="/blog/assets/js/129.66434f30.js"><link rel="prefetch" href="/blog/assets/js/13.09fb4992.js"><link rel="prefetch" href="/blog/assets/js/130.3d1bc470.js"><link rel="prefetch" href="/blog/assets/js/131.a429076f.js"><link rel="prefetch" href="/blog/assets/js/132.d92847f6.js"><link rel="prefetch" href="/blog/assets/js/133.5f6c9cb7.js"><link rel="prefetch" href="/blog/assets/js/134.962bc62a.js"><link rel="prefetch" href="/blog/assets/js/135.035b6441.js"><link rel="prefetch" href="/blog/assets/js/136.09994e71.js"><link rel="prefetch" href="/blog/assets/js/137.0fcd0d13.js"><link rel="prefetch" href="/blog/assets/js/138.72528047.js"><link rel="prefetch" href="/blog/assets/js/139.dc81dfd4.js"><link rel="prefetch" href="/blog/assets/js/14.3334341c.js"><link rel="prefetch" href="/blog/assets/js/140.8ab28b43.js"><link rel="prefetch" href="/blog/assets/js/15.a36c96d5.js"><link rel="prefetch" href="/blog/assets/js/16.225efb8e.js"><link rel="prefetch" href="/blog/assets/js/17.d25544aa.js"><link rel="prefetch" href="/blog/assets/js/18.e0eff833.js"><link rel="prefetch" href="/blog/assets/js/19.873939e2.js"><link rel="prefetch" href="/blog/assets/js/20.c0695f50.js"><link rel="prefetch" href="/blog/assets/js/21.cb758585.js"><link rel="prefetch" href="/blog/assets/js/22.8cc82a0d.js"><link rel="prefetch" href="/blog/assets/js/23.61683c18.js"><link rel="prefetch" href="/blog/assets/js/24.abc14c77.js"><link rel="prefetch" href="/blog/assets/js/25.3abbac85.js"><link rel="prefetch" href="/blog/assets/js/26.24c045ca.js"><link rel="prefetch" href="/blog/assets/js/27.f060526e.js"><link rel="prefetch" href="/blog/assets/js/28.19df1952.js"><link rel="prefetch" href="/blog/assets/js/29.cbab0acc.js"><link rel="prefetch" href="/blog/assets/js/3.82955452.js"><link rel="prefetch" href="/blog/assets/js/30.29679457.js"><link rel="prefetch" href="/blog/assets/js/31.45e421f1.js"><link rel="prefetch" href="/blog/assets/js/32.03e54704.js"><link rel="prefetch" href="/blog/assets/js/33.12b3d700.js"><link rel="prefetch" href="/blog/assets/js/34.b69eee70.js"><link rel="prefetch" href="/blog/assets/js/35.2f44c075.js"><link rel="prefetch" href="/blog/assets/js/36.b70b615d.js"><link rel="prefetch" href="/blog/assets/js/37.ad67dc4c.js"><link rel="prefetch" href="/blog/assets/js/38.e9f7484c.js"><link rel="prefetch" href="/blog/assets/js/39.04e13871.js"><link rel="prefetch" href="/blog/assets/js/4.37ee34bb.js"><link rel="prefetch" href="/blog/assets/js/40.c8964901.js"><link rel="prefetch" href="/blog/assets/js/41.1a8e7db7.js"><link rel="prefetch" href="/blog/assets/js/42.37ca084e.js"><link rel="prefetch" href="/blog/assets/js/43.c4bcf16a.js"><link rel="prefetch" href="/blog/assets/js/44.a3323477.js"><link rel="prefetch" href="/blog/assets/js/45.93e9be34.js"><link rel="prefetch" href="/blog/assets/js/46.6d1392cc.js"><link rel="prefetch" href="/blog/assets/js/47.3ad706da.js"><link rel="prefetch" href="/blog/assets/js/48.32158acd.js"><link rel="prefetch" href="/blog/assets/js/49.527c392f.js"><link rel="prefetch" href="/blog/assets/js/5.ecc55f8f.js"><link rel="prefetch" href="/blog/assets/js/50.1464b14b.js"><link rel="prefetch" href="/blog/assets/js/51.ed03a022.js"><link rel="prefetch" href="/blog/assets/js/52.d3121a62.js"><link rel="prefetch" href="/blog/assets/js/53.7dfae514.js"><link rel="prefetch" href="/blog/assets/js/54.f448f190.js"><link rel="prefetch" href="/blog/assets/js/55.9c94df86.js"><link rel="prefetch" href="/blog/assets/js/56.bda13573.js"><link rel="prefetch" href="/blog/assets/js/57.d9c99fc0.js"><link rel="prefetch" href="/blog/assets/js/58.b9918aea.js"><link rel="prefetch" href="/blog/assets/js/59.648f56cf.js"><link rel="prefetch" href="/blog/assets/js/6.7996e4f4.js"><link rel="prefetch" href="/blog/assets/js/60.95e7d166.js"><link rel="prefetch" href="/blog/assets/js/61.f123e9a0.js"><link rel="prefetch" href="/blog/assets/js/62.9bf9a831.js"><link rel="prefetch" href="/blog/assets/js/63.1cc5f6b3.js"><link rel="prefetch" href="/blog/assets/js/64.ad1458c7.js"><link rel="prefetch" href="/blog/assets/js/65.4c082613.js"><link rel="prefetch" href="/blog/assets/js/66.3ceb9bfc.js"><link rel="prefetch" href="/blog/assets/js/67.055a8c8a.js"><link rel="prefetch" href="/blog/assets/js/68.b8971a8e.js"><link rel="prefetch" href="/blog/assets/js/69.cb0114dc.js"><link rel="prefetch" href="/blog/assets/js/7.b03118d7.js"><link rel="prefetch" href="/blog/assets/js/70.206b25fd.js"><link rel="prefetch" href="/blog/assets/js/71.028b3967.js"><link rel="prefetch" href="/blog/assets/js/72.c676af4a.js"><link rel="prefetch" href="/blog/assets/js/73.b546ba6d.js"><link rel="prefetch" href="/blog/assets/js/74.74cb0295.js"><link rel="prefetch" href="/blog/assets/js/75.d6a54f3a.js"><link rel="prefetch" href="/blog/assets/js/76.7bbe8691.js"><link rel="prefetch" href="/blog/assets/js/77.4237d036.js"><link rel="prefetch" href="/blog/assets/js/78.d40494a8.js"><link rel="prefetch" href="/blog/assets/js/79.d5795e49.js"><link rel="prefetch" href="/blog/assets/js/80.982b7389.js"><link rel="prefetch" href="/blog/assets/js/81.6a209c1f.js"><link rel="prefetch" href="/blog/assets/js/82.a630443a.js"><link rel="prefetch" href="/blog/assets/js/83.5a0ed4a6.js"><link rel="prefetch" href="/blog/assets/js/84.3694f4b0.js"><link rel="prefetch" href="/blog/assets/js/85.cda1ec45.js"><link rel="prefetch" href="/blog/assets/js/86.350eb673.js"><link rel="prefetch" href="/blog/assets/js/87.9a09df4e.js"><link rel="prefetch" href="/blog/assets/js/88.656ee591.js"><link rel="prefetch" href="/blog/assets/js/89.1e996c9c.js"><link rel="prefetch" href="/blog/assets/js/9.fd302aac.js"><link rel="prefetch" href="/blog/assets/js/90.83aaaf5d.js"><link rel="prefetch" href="/blog/assets/js/91.13a3c700.js"><link rel="prefetch" href="/blog/assets/js/92.41a35f2f.js"><link rel="prefetch" href="/blog/assets/js/93.c7a70239.js"><link rel="prefetch" href="/blog/assets/js/94.811e50a4.js"><link rel="prefetch" href="/blog/assets/js/95.d0844395.js"><link rel="prefetch" href="/blog/assets/js/96.a16b15aa.js"><link rel="prefetch" href="/blog/assets/js/97.24d57891.js"><link rel="prefetch" href="/blog/assets/js/98.c9732b15.js"><link rel="prefetch" href="/blog/assets/js/99.2166c278.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.538de7b2.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/assets/common/logo2.png" alt="小兔在冲浪" class="logo"> <span class="site-name can-hide">小兔在冲浪</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础|博文" class="dropdown-title"><a href="/blog/web/" class="link-title">基础|博文</a> <span class="title" style="display:none;">基础|博文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础知识点</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/pages/4456e3/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/blog/pages/a0057b/" class="nav-link">ES6</a></li><li class="dropdown-subitem"><a href="/blog/pages/a0057b/" class="nav-link">HTML与CSS</a></li><li class="dropdown-subitem"><a href="/blog/pages/a0057b/" class="nav-link">JS设计模式</a></li></ul></li><li class="dropdown-item"><h4>我的博文</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/pages/a0057b/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/blog/pages/a0057b/" class="nav-link">React</a></li><li class="dropdown-subitem"><a href="/blog/pages/a0057b/" class="nav-link">Webpack</a></li><li class="dropdown-subitem"><a href="/blog/pages/a0057b/" class="nav-link">Nodejs</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法|试题" class="dropdown-title"><a href="/blog/algorithm/" class="link-title">算法|试题</a> <span class="title" style="display:none;">算法|试题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/7d4d69/" class="nav-link">排序算法</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/a0057b/" class="nav-link">LeetCode</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/a0057b/" class="nav-link">算法面试题解</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="插件|框架" class="dropdown-title"><a href="/blog/services/" class="link-title">插件|框架</a> <span class="title" style="display:none;">插件|框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/a0057b/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/a0057b/" class="nav-link">React</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目|工具" class="dropdown-title"><a href="/blog/tools/" class="link-title">项目|工具</a> <span class="title" style="display:none;">项目|工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/docs/" class="nav-link">项目搭建</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/docs/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/git/" class="nav-link">Git技巧</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/blog/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/learning/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/interview/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/mood/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/skill/" class="nav-link">实用技巧</a></li></ul></div></div> <a href="https://github.com/lacorda/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/blog/assets/common/logo3.png"> <div class="blogger-info"><h3>小兔</h3> <span>前端菜鸟</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础|博文" class="dropdown-title"><a href="/blog/web/" class="link-title">基础|博文</a> <span class="title" style="display:none;">基础|博文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础知识点</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/pages/4456e3/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/blog/pages/a0057b/" class="nav-link">ES6</a></li><li class="dropdown-subitem"><a href="/blog/pages/a0057b/" class="nav-link">HTML与CSS</a></li><li class="dropdown-subitem"><a href="/blog/pages/a0057b/" class="nav-link">JS设计模式</a></li></ul></li><li class="dropdown-item"><h4>我的博文</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/pages/a0057b/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/blog/pages/a0057b/" class="nav-link">React</a></li><li class="dropdown-subitem"><a href="/blog/pages/a0057b/" class="nav-link">Webpack</a></li><li class="dropdown-subitem"><a href="/blog/pages/a0057b/" class="nav-link">Nodejs</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法|试题" class="dropdown-title"><a href="/blog/algorithm/" class="link-title">算法|试题</a> <span class="title" style="display:none;">算法|试题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/7d4d69/" class="nav-link">排序算法</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/a0057b/" class="nav-link">LeetCode</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/a0057b/" class="nav-link">算法面试题解</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="插件|框架" class="dropdown-title"><a href="/blog/services/" class="link-title">插件|框架</a> <span class="title" style="display:none;">插件|框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/a0057b/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/a0057b/" class="nav-link">React</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目|工具" class="dropdown-title"><a href="/blog/tools/" class="link-title">项目|工具</a> <span class="title" style="display:none;">项目|工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/docs/" class="nav-link">项目搭建</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/docs/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/git/" class="nav-link">Git技巧</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/blog/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/learning/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/interview/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/mood/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/skill/" class="nav-link">实用技巧</a></li></ul></div></div> <a href="https://github.com/lacorda/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Flux架构</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Vue</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/pages/28af0c/" class="sidebar-link">从源码看vue运行机制</a></li><li><a href="/blog/pages/2a7622/" class="sidebar-link">响应式、数据绑定、依赖收集</a></li><li><a href="/blog/pages/ffbe35/" class="sidebar-link">computed的实现原理</a></li><li><a href="/blog/pages/15d7ff/" class="sidebar-link">watch的实现原理</a></li><li><a href="/blog/pages/a13a4a/" class="sidebar-link">从template到vnode</a></li><li><a href="/blog/pages/e6292e/" aria-current="page" class="active sidebar-link">从vnode到更新视图</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/pages/e6292e/#update方法" class="sidebar-link">_update方法</a></li><li class="sidebar-sub-header"><a href="/blog/pages/e6292e/#patch" class="sidebar-link">patch</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/pages/e6292e/#dif算法" class="sidebar-link">dif算法</a></li></ul></li></ul></li><li><a href="/blog/pages/c41ff0/" class="sidebar-link">vuex中的mapState,mapMuations,mapGetters等的原理</a></li><li><a href="/blog/pages/6cb224/" class="sidebar-link">v-bind</a></li><li><a href="/blog/pages/c720a0/" class="sidebar-link">组件间的通信</a></li><li><a href="/blog/pages/637001/" class="sidebar-link">slot</a></li><li><a href="/blog/pages/cd87dc/" class="sidebar-link">动态组件和keep-alive</a></li><li><a href="/blog/pages/e78bda/" class="sidebar-link">生命周期</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nodejs</span> <span class="arrow right"></span></p> <!----></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-33863c7e><div class="articleInfo" data-v-33863c7e><ul class="breadcrumbs" data-v-33863c7e><li data-v-33863c7e><a href="/blog/" title="首页" class="iconfont icon-home router-link-active" data-v-33863c7e></a></li> <li data-v-33863c7e><a href="/blog/pages/f87c0a/" title="插件|框架-目录页" data-v-33863c7e>插件|框架</a></li> <li data-v-33863c7e><a href="/blog/pages/f87c0a/#Vue" title="插件|框架#Vue" data-v-33863c7e>Vue</a></li> <!----></ul> <div class="info" data-v-33863c7e><div title="作者" class="author iconfont icon-touxiang" data-v-33863c7e><a href="https://github.com/lacorda" target="_blank" title="作者" class="beLink" data-v-33863c7e>小兔</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-33863c7e><a href="javascript:;" data-v-33863c7e>2021-05-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">
          从vnode到更新视图
        </h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><h2 id="update方法"><a href="#update方法" class="header-anchor">#</a> _update方法</h2> <ul><li>第一个参数是一个<code>VNode</code>对象，在内部会将该<code>VNode</code>对象与之前<code>旧的VNode</code>对象进行<code>__patch_</code></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/core/instance/lifecycle.js</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> activeInstance<span class="token operator">:</span> any <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_update</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> hydrating<span class="token operator">?</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm<span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">/*如果该组件已经挂载过了则代表进入这个步骤是个更新的过程，触发beforeUpdate钩子*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeUpdate'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> prevEl <span class="token operator">=</span> vm<span class="token punctuation">.</span>$el
    <span class="token keyword">const</span> prevVnode <span class="token operator">=</span> vm<span class="token punctuation">.</span>_vnode
    <span class="token keyword">const</span> prevActiveInstance <span class="token operator">=</span> activeInstance
    activeInstance <span class="token operator">=</span> vm
    vm<span class="token punctuation">.</span>_vnode <span class="token operator">=</span> vnode
    <span class="token comment">/*基于后端渲染Vue.prototype.__patch__被用来作为一个入口*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>
            vm<span class="token punctuation">.</span>$el<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* removeOnly */</span><span class="token punctuation">,</span>
            vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_parentElm<span class="token punctuation">,</span>
            vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_refElm
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>prevVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    activeInstance <span class="token operator">=</span> prevActiveInstance
    <span class="token comment">/*更新新的实例对象的__vue__*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevEl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        prevEl<span class="token punctuation">.</span>__vue__ <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span>$el<span class="token punctuation">.</span>__vue__ <span class="token operator">=</span> vm
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$vnode <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>$vnode <span class="token operator">===</span> vm<span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>_vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span>$el
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h2 id="patch"><a href="#patch" class="header-anchor">#</a> patch</h2> <ul><li>新老<code>VNode</code>节点进行<code>比对</code>，然后将根据两者的比较结果进行<font color="red">最小单位地修改视图</font></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/platforms/web/runtime/index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> patch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./patch'</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__patch__ <span class="token operator">=</span> inBrowser <span class="token operator">?</span> patch <span class="token operator">:</span>

<span class="token comment">// src/platforms/web/runtime/patch.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createPatchFunction <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/vdom/patch'</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> patch<span class="token operator">:</span> Function <span class="token operator">=</span> <span class="token function">createPatchFunction</span><span class="token punctuation">(</span><span class="token punctuation">{</span> nodeOps<span class="token punctuation">,</span> modules <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// src/core/vdom/patch.js</span>
<span class="token keyword">const</span> hooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'create'</span><span class="token punctuation">,</span> <span class="token string">'activate'</span><span class="token punctuation">,</span> <span class="token string">'update'</span><span class="token punctuation">,</span> <span class="token string">'remove'</span><span class="token punctuation">,</span> <span class="token string">'destroy'</span><span class="token punctuation">]</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createPatchFunction</span> <span class="token punctuation">(</span><span class="token parameter">backend</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cbs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">/*
        nodeOps  见platforms/web(weex)/runtime/node-ops.js  实际上是操作节点（分平台，比如web上是Dom节点的操作）的方法集合的一个适配层，保证不同平台使用同样的对外接口操作节点。
        modules  见/platforms/web(weex)/runtime/modules  =&gt; vnode一些属性的设置更新，=&gt; [attrs,klass,events,domProps,style,transition]
    */</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> modules<span class="token punctuation">,</span> nodeOps <span class="token punctuation">}</span> <span class="token operator">=</span> backend

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> hooks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cbs<span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> modules<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>modules<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cbs<span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>modules<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">patch</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> removeOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h5 id="patch源码解析"><a href="#patch源码解析" class="header-anchor">#</a> patch源码解析</h5> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/core/vdom/patch.js</span>

<span class="token comment">/*createPatchFunction的返回值，一个patch函数*/</span>
<span class="token keyword">function</span> <span class="token function">patch</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> removeOnly<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*vnode不存在则直接调用销毁钩子*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span>  <span class="token comment">// isDef = isDefined..不等于undefined或null</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> isInitialPatch <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">const</span> insertedVnodeQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*oldVnode未定义的时候，其实也就是root节点，创建一个新的节点*/</span>
        isInitialPatch <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token function">createElm</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">/*标记旧的VNode是否有nodeType*/</span>
        <span class="token comment">/*Github:https://github.com/answershuto*/</span>
        <span class="token keyword">const</span> isRealElement <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRealElement <span class="token operator">&amp;&amp;</span> <span class="token function">sameVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*!!!!! 是同一个节点的时候直接修改现有的节点*/</span>
            <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isRealElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> oldVnode<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token constant">SSR_ATTR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">/*当旧的VNode是服务端渲染的元素，hydrating记为true*/</span>
                    oldVnode<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token constant">SSR_ATTR</span><span class="token punctuation">)</span>
                    hydrating <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>hydrating<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">/*需要合并到真实DOM上*/</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hydrate</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">/*调用insert钩子*/</span>
                        <span class="token function">invokeInsertHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> oldVnode
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">warn</span><span class="token punctuation">(</span>
                            <span class="token string">'The client-side rendered virtual DOM tree is not matching '</span> <span class="token operator">+</span>
                            <span class="token string">'server-rendered content. This is likely caused by incorrect '</span> <span class="token operator">+</span>
                            <span class="token string">'HTML markup, for example nesting block-level elements inside '</span> <span class="token operator">+</span>
                            <span class="token string">'&lt;p&gt;, or missing &lt;tbody&gt;. Bailing hydration and performing '</span> <span class="token operator">+</span>
                            <span class="token string">'full client-side render.'</span>
                        <span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">/*如果不是服务端渲染或者合并到真实DOM失败，则创建一个空的VNode节点替换它*/</span>
                oldVnode <span class="token operator">=</span> <span class="token function">emptyNodeAt</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">/*取代现有元素*/</span>
            <span class="token keyword">const</span> oldElm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm
            <span class="token keyword">const</span> parentElm <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span>
            <span class="token function">createElm</span><span class="token punctuation">(</span>
                vnode<span class="token punctuation">,</span>
                insertedVnodeQueue<span class="token punctuation">,</span>
                oldElm<span class="token punctuation">.</span>_leaveCb <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> parentElm<span class="token punctuation">,</span>
                nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/*组件根节点被替换，遍历更新父节点element*/</span>
                <span class="token keyword">let</span> ancestor <span class="token operator">=</span> vnode<span class="token punctuation">.</span>parent
                <span class="token keyword">while</span> <span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ancestor<span class="token punctuation">.</span>elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm
                    ancestor <span class="token operator">=</span> ancestor<span class="token punctuation">.</span>parent
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPatchable</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">/*调用create回调*/</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        cbs<span class="token punctuation">.</span>create<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>parent<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/*移除老节点*/</span>
                <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/*Github:https://github.com/answershuto*/</span>
                <span class="token comment">/*调用destroy钩子*/</span>
                <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*调用insert钩子*/</span>
    <span class="token function">invokeInsertHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> isInitialPatch<span class="token punctuation">)</span>
    <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>elm
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br></div></div><h3 id="dif算法"><a href="#dif算法" class="header-anchor">#</a> dif算法</h3> <blockquote><p>同层级的<code>VNode</code>之间进行比较得到变化，然后修改变化的视图, 时间复杂度只有O(n)，是一种相当高效的算法
图解:
<img src="/blog/assets/img/vue-08.104740ce.png" alt=""> <img src="data:image/png;base64,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" alt=""></p></blockquote> <h5 id="samevnode源码解析"><a href="#samevnode源码解析" class="header-anchor">#</a> sameVnode源码解析</h5> <p>判断两个VNode节点是否是同一个节点，需要满足以下条件:</p> <ul><li><code>key</code>相同</li> <li><code>tag</code>（当前节点的标签名）相同</li> <li><code>isComment</code>（是否为注释节点）相同</li> <li>是否<code>data</code>都有定义</li> <li>当标签是<code>&lt;input&gt;</code>的时候，<code>type</code>和<code>attrs</code>必须相同</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/core/vdom/patch.js</span>
<span class="token comment">/*
  判断两个VNode节点是否是同一个节点，需要满足以下条件
  key相同
  tag（当前节点的标签名）相同
  isComment（是否为注释节点）相同
  是否data（当前节点对应的对象，包含了具体的一些数据信息，是一个VNodeData类型，可以参考VNodeData类型中的数据信息）都有定义
  当标签是&lt;input&gt;的时候，type必须相同
*/</span>
<span class="token keyword">function</span> <span class="token function">sameVnode</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    a<span class="token punctuation">.</span>key <span class="token operator">===</span> b<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span>
    a<span class="token punctuation">.</span>tag <span class="token operator">===</span> b<span class="token punctuation">.</span>tag <span class="token operator">&amp;&amp;</span>
    a<span class="token punctuation">.</span>isComment <span class="token operator">===</span> b<span class="token punctuation">.</span>isComment <span class="token operator">&amp;&amp;</span>
    <span class="token function">isDef</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">isDef</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token function">sameInputType</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
  判断当标签是&lt;input&gt;的时候，type是否相同
  某些浏览器不支持动态修改&lt;input&gt;类型，所以他们被视为不同节点
*/</span>
<span class="token keyword">function</span> <span class="token function">sameInputType</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token string">'input'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token keyword">let</span> i
  <span class="token keyword">const</span> typeA <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> a<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>attrs<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span>type
  <span class="token keyword">const</span> typeB <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> b<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>attrs<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span>type
  <span class="token keyword">return</span> typeA <span class="token operator">===</span> typeB
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h5 id="patchvnode源码解析"><a href="#patchvnode源码解析" class="header-anchor">#</a> patchVnode源码解析</h5> <p>patchVnode的规则是这样的：</p> <ol><li>新旧<code>VNode</code>相同，直接返回</li> <li>新旧<code>VNode</code>都是静态的，且key相同(代表同一节点)，并且新的VNode是clone或者是标记了once（标记v-once属性，只渲染一次）=&gt; 替换elm以及componentInstance</li> <li>新<code>VNode</code>有<code>text</code>节点，且当新旧<code>VNode</code>的<code>text</code>不一样时，直接替换这段文本</li> <li>新<code>VNode</code>没有<code>text</code>节点
<ol><li>新旧<code>VNode</code>均无<code>children</code>子节点，只是文本的替换</li> <li>旧<code>VNode</code>没有<code>children</code>子节点，且新<code>VNode</code>有<code>children</code>子节点，先<code>清空</code>旧<code>VNode</code>的<code>DOM的文本内容</code>，然后为当前DOM节点<code>加入``子节点</code> =&gt; <code>addVnodes</code>。</li> <li>旧<code>VNode</code>有<code>children</code>子节点，且新<code>VNode</code>没有<code>children</code>子节点，则<code>移除</code>该DOM节点的所有子节点</li> <li>新旧<code>VNode</code>均有<code>children</code>子节点，则对子节点进行<code>diff</code>操作，调用<code>updateChildren</code>，这个<code>updateChildren</code>也是<code>diff</code>的核心</li></ol></li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/core/vdom/patch.js</span>
<span class="token comment">/*patch VNode节点*/</span>
<span class="token keyword">function</span> <span class="token function">patchVnode</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*两个VNode节点相同则直接返回*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode <span class="token operator">===</span> vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*
      如果新旧VNode都是静态的，同时它们的key相同（代表同一节点），
      并且新的VNode是clone或者是标记了once（标记v-once属性，只渲染一次），
      那么只需要替换elm以及componentInstance即可。
    */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isStatic<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">isTrue</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>isStatic<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        vnode<span class="token punctuation">.</span>key <span class="token operator">===</span> oldVnode<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isCloned<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isOnce<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm
        vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>componentInstance
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> i
    <span class="token keyword">const</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>prepatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*i = data.hook.prepatch，如果存在的话，见&quot;./create-component componentVNodeHooks&quot;。*/</span>
        <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm
    <span class="token keyword">const</span> oldCh <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children
    <span class="token keyword">const</span> ch <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPatchable</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*调用update回调以及update钩子*/</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*!!! 如果这个VNode节点为text文本时*/</span>
    <span class="token comment">// ps: vnode.text存在时，肯定是文本节点，因为包含text和children的节点vnode.text为undefined</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*新老节点均有children子节点，则对子节点进行diff操作，调用updateChildren*/</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh <span class="token operator">!==</span> ch<span class="token punctuation">)</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*如果老节点没有子节点而新节点存在子节点，先清空elm的文本内容，然后为当前节点加入子节点*/</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
            <span class="token function">addVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*当新节点没有子节点而老节点有子节点的时候，则移除所有ele的子节点*/</span>
            <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*当新老节点都无子节点的时候，但老节点是文本节点，只是文本的替换，因为这个逻辑中新节点text不存在，所以直接去除ele的文本*/</span>
            nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*当新老节点text不一样时，直接替换这段文本*/</span>
        nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*调用postpatch钩子*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>postpatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><h5 id="updatechildren源码解析"><a href="#updatechildren源码解析" class="header-anchor">#</a> updateChildren源码解析</h5> <p><img src="/blog/assets/img/vue-10.9d4a83c7.png" alt="">
diff比较过程:</p> <ol><li><strong>新旧<code>VNode</code>的首尾都添加一个<code>变量标记索引值</code>，在遍历过程中这几个变量都会向<code>中间靠拢</code></strong></li> <li>变量索引值 与 VNode 一一对应: <code>oldStartIdx =&gt; oldStartVnode</code> / <code>oldEndIdx =&gt; oldEndVnode</code> /  <code>newStartIdx =&gt; newStartVnode</code> / <code>newEndIdx =&gt; newEndVnode</code></li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateChildren</span> <span class="token punctuation">(</span><span class="token parameter">parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始时 newStartIdx=0; newEndIdx = newCh.length - 1;  /  oldStartIdx=0; oldEndIdx = oldCh.length - 1;</span>
    <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span>
    <span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span>
    <span class="token keyword">let</span> oldKeyToIdx<span class="token punctuation">,</span> idxInOld<span class="token punctuation">,</span> elmToMove<span class="token punctuation">,</span> refElm

    <span class="token keyword">const</span> canMove <span class="token operator">=</span> <span class="token operator">!</span>removeOnly

    <span class="token comment">// 遍历过程中，改变 startIndex 和 endIndex 不断往中间靠拢</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>               <span class="token comment">// 旧 start vnode 不存在, 往后移一位</span>
            oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment">// 旧 end vnode 不存在, 往前移一位</span>
            oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 新旧 start vnode 相同时，比较两个vnode。且新旧 start vnode 都往后移一位</span>
            <span class="token comment">/*前四种情况其实是指定key的时候，判定为同一个VNode，则直接patchVnode即可，分别比较oldCh以及newCh的两头节点2*2=4种情况*/</span>
            <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
            oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
            newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 新旧 end vnode 相同时，比较两个vnode。且新旧 end vnode 都往前移一位</span>
            <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
            oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
            newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 旧 start vnode 与 新 end vnode相同(说明oldStartVnode已经跑到了oldEndVnode后面)</span>
            <span class="token comment">// =&gt; 旧 start vnode往后移一位（移到最后），新 end vnode往前移一位</span>
            <span class="token comment">// =&gt; 直接将 旧的真实DOM节点 移到oldEndVnode后面</span>
            <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
            canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">)</span>
            oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
            newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 旧 end vnode 与 新 start vnode相同(相当于是vnode发生了前移)</span>
            <span class="token comment">// 比较两个vnode，且将旧 end node 移到 旧 start vnode前（移到第一位）</span>
            <span class="token comment">// 然后，旧 end vnode往前移一位（为空），新 start vnode往后移一位</span>
            <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
            canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>
            oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
            newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">/*
            首尾未有相同时:
            createKeyToOldIdx =&gt; 生成一个key与旧 vnode 的key对应的哈希表（只有第一次undefined的时候会生成，也为后面检测重复的key值做铺垫）
            比如childre是这样的 [{xx: xx, key: 'key0'}, {xx: xx, key: 'key1'}, {xx: xx, key: 'key2'}]  beginIdx = 0   endIdx = 2
            结果生成{key0: 0, key1: 1, key2: 2}
            */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldKeyToIdx<span class="token punctuation">)</span><span class="token punctuation">)</span> oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>
            <span class="token comment">/*如果 新 start vnode 存在key, 且这个key在 old vnode 中能找到则返回这个节点的idxInOld（即第几个节点，下标）*/</span>
            idxInOld <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">?</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">null</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// New element</span>
                <span class="token comment">/*新 start vnode 没有key或者是该 key 没有在 old vnode 中找到则创建一个新的节点*/</span>
                <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>
                newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">/*获取同key的老节点*/</span>
                elmToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span>
                <span class="token comment">/* istanbul ignore if */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>elmToMove<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">/*如果elmToMove不存在说明之前已经有新节点放入过这个key的DOM中，提示可能存在重复的key，确保v-for的时候item有唯一的key值*/</span>
                    <span class="token function">warn</span><span class="token punctuation">(</span>
                    <span class="token string">'It seems there are duplicate keys that is causing an update error. '</span> <span class="token operator">+</span>
                    <span class="token string">'Make sure each v-for item has a unique key.'</span>
                    <span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>elmToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">/*如果新 vnode 与得到的 有相同key的节点 是同一个 vnode 则进行patchVnode*/</span>
                    <span class="token function">patchVnode</span><span class="token punctuation">(</span>elmToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>

                    <span class="token comment">/*因为已经patchVnode进去了，所以将这个老节点赋值undefined，之后如果还有新节点与该节点key相同可以检测出来提示已有重复的key*/</span>
                    oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span>

                    <span class="token comment">/*当有标识位canMove时，可以直接插入oldStartVnode对应的真实DOM节点前面*/</span>
                    canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>
                    newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>  <span class="token comment">// 新 start vnode 都往后移一位</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">/*当新 vnode 与找到的同样key的 vnode 不是sameVNode的时候（比如说tag不一样或者是有不一样type的input标签），创建一个新的节点*/</span>
                    <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>
                    newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>  <span class="token comment">// 新 start vnode 都往后移一位</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&gt;</span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/*全部比较完成以后，发现oldStartIdx &gt; oldEndIdx的话，说明老节点已经遍历完了，新节点比老节点多，所以这时候多出来的新节点需要一个一个创建出来加入到真实DOM中*/</span>
      refElm <span class="token operator">=</span> <span class="token function">isUndef</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>elm
      <span class="token function">addVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartIdx <span class="token operator">&gt;</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/*如果全部比较完成以后发现newStartIdx &gt; newEndIdx，则说明新节点已经遍历完了，老节点多余新节点，这个时候需要将多余的老节点从真实DOM中移除*/</span>
      <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br></div></div></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/lacorda/blog/edit/master/docs/03.插件|框架/01.Vue/06.从vnode到更新视图.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021/05/21, 18:51:18</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/blog/pages/a13a4a/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">从template到vnode</div></a> <a href="/blog/pages/c41ff0/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">vuex中的mapState,mapMuations,mapGetters等的原理</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/pages/a13a4a/" class="prev">从template到vnode</a></span> <span class="next"><a href="/blog/pages/c41ff0/">vuex中的mapState,mapMuations,mapGetters等的原理</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2021
    <span>小兔在冲浪 | <a href="https://github.com/lacorda/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">跟随系统</li><li class="iconfont icon-rijianmoshi">浅色模式</li><li class="iconfont icon-yejianmoshi">深色模式</li><li class="iconfont icon-yuedu">阅读模式</li></ul></div></div> <!----> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><i class="close-but">×</i> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/blog/assets/js/app.307d5cc3.js" defer></script><script src="/blog/assets/js/2.05990a35.js" defer></script><script src="/blog/assets/js/8.a97ebc1a.js" defer></script>
  </body>
</html>